<!DOCTYPE html>
<html>
<head>
<title>Admin Panel | Aftab Store</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>

body{
font-family:Arial;
margin:0;
background:#111;
color:#fff;
}

.box{
width:100%;
min-height:100vh;
margin:0;
background:#fff;
color:#000;
padding:15px;
box-sizing:border-box;
}

input,button,select{
width:100%;
padding:12px;
margin:6px 0;
border-radius:6px;
border:1px solid #ccc;
}

button{
background:#28a745;
color:white;
border:none;
font-weight:bold;
}

.red{background:red}
.orange{background:orange}

.item,.orderBox{
border:1px solid #ccc;
padding:8px;
margin:6px 0;
border-radius:6px;
font-size:14px;
}

</style>
</head>

<body>

<div class="box" id="loginBox">

<h2>Admin Login</h2>

<input id="email" placeholder="Email">
<input id="pass" type="password">

<button onclick="login()">Login</button>

<p id="msg" style="color:red"></p>

</div>


<div class="box" id="panel" style="display:none">

<h2>üì¶ Admin Dashboard</h2>

<hr>

<!-- SALES -->
<h3>üìä Sales Report</h3>

<select id="filter" onchange="loadOrders()">
<option value="1">Today</option>
<option value="7">Last 7 Days</option>
<option value="30">Last 30 Days</option>
</select>

<h4>Total: ‚Çπ<span id="totalSale">0</span></h4>

<hr>

<!-- ADD PRODUCT -->
<h3>Add Product</h3>

<input id="pname" placeholder="Name">
<input id="price" type="number" placeholder="Price">
<input id="stock" type="number" placeholder="Stock">

<button onclick="addProduct()">Add</button>

<hr>

<h3>Products</h3>
<div id="products"></div>

<hr>

<h3>Orders üîî</h3>
<div id="orders"></div>

<hr>

<button class="red" onclick="logout()">Logout</button>

</div>


<script>

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyA8O4kOinBczBQ8r9mbtOdH98X70ezpgYk",
authDomain:"new-prototype-s7zo4.firebaseapp.com",
projectId:"new-prototype-s7zo4"
});

const auth=firebase.auth();
const db=firebase.firestore();


/* AUTO LOGIN */
auth.onAuthStateChanged(async user=>{

if(!user) return;

let doc=await db.collection("Users").doc(user.uid).get();

if(!doc.exists||doc.data().role!=="admin"){
auth.signOut();
return;
}

loginBox.style.display="none";
panel.style.display="block";

loadProducts();
loadOrders();
listenOrders();

});


/* LOGIN */
async function login(){

try{

let c=await auth.signInWithEmailAndPassword(
email.value,pass.value
);

let d=await db.collection("Users").doc(c.user.uid).get();

if(d.data().role!=="admin"){
alert("Not Admin");
auth.signOut();
return;
}

}catch{
msg.innerText="Wrong Login";
}

}


/* REALTIME ORDER ALERT */
function listenOrders(){

db.collection("Orders")
.orderBy("time","desc")
.limit(1)
.onSnapshot(snap=>{

snap.docChanges().forEach(c=>{

if(c.type==="added"){
alert("üîî New Order Received!");
loadOrders();
}

});

});

}


/* LOGOUT */
function logout(){
auth.signOut();
location.reload();
}


/* ADD PRODUCT */
async function addProduct(){

if(!pname.value)return;

await db.collection("Products").add({

name:pname.value,
price:+price.value,
stock:+stock.value,
time:firebase.firestore.FieldValue.serverTimestamp()

});

pname.value="";
price.value="";
stock.value="";

loadProducts();

}


/* PRODUCTS */
async function loadProducts(){

let snap=await db.collection("Products").get();

products.innerHTML="";

snap.forEach(d=>{

let p=d.data();

products.innerHTML+=`

<div class="item">

${p.name} ‚Çπ${p.price}
(Stock:${p.stock})

<button onclick="del('${d.id}')">‚ùå</button>

</div>

`;

});

}


function del(id){
db.collection("Products").doc(id).delete();
loadProducts();
}


/* ORDERS */
async function loadOrders(){

let days=filter.value;

let from=new Date();
from.setDate(from.getDate()-days);

let snap=await db.collection("Orders")
.where("time",">=",from)
.orderBy("time","desc")
.get();

orders.innerHTML="";

let total=0;

snap.forEach(d=>{

let o=d.data();

total+=o.total;

orders.innerHTML+=`

<div class="orderBox">

<b>${o.name}</b>
(${o.mobile})<br>

${o.items}<br>

‚Çπ${o.total}<br>

Status: <b>${o.status}</b><br>

<button class="orange"
onclick="cancelOrder('${d.id}')">
Cancel
</button>

</div>

`;

});

totalSale.innerText=total;

}


/* CANCEL ORDER */
async function cancelOrder(id){

if(!confirm("Cancel Order?")) return;

await db.collection("Orders").doc(id).update({

status:"Cancelled"

});

loadOrders();

}

</script>

</body>
</html>

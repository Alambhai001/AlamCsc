<!DOCTYPE html>
<html>
<head>
<title>Admin Panel | Aftab Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
body{
margin:0;
font-family:Arial;
background:#111;
color:#fff;
}

.box{
width:100%;
max-width:500px;
min-height:100vh;
margin:auto;
background:#fff;
color:#000;
padding:15px;
box-sizing:border-box;
}

h2,h3{text-align:center}

input,button{
width:100%;
padding:12px;
margin:6px 0;
border-radius:6px;
border:1px solid #ccc;
font-size:15px;
}

button{
background:#28a745;
color:white;
border:none;
font-weight:bold;
}

.red{background:red}
.orange{background:orange}

.item,.orderBox{
border:1px solid #ddd;
padding:8px;
margin:6px 0;
border-radius:6px;
font-size:14px;
}

.stat{
background:#eee;
padding:8px;
margin:5px 0;
border-radius:5px;
font-weight:bold;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">

<h2>ğŸ” Admin Login</h2>

<input id="email" placeholder="Email">
<input id="pass" type="password">

<button onclick="login()">Login</button>

<p id="msg" style="color:red"></p>

</div>


<!-- PANEL -->
<div class="box" id="panel" style="display:none">

<h2>ğŸ“¦ Admin Dashboard</h2>

<!-- REPORT -->
<div class="stat">Today: â‚¹ <span id="today">0</span></div>
<div class="stat">7 Days: â‚¹ <span id="week">0</span></div>
<div class="stat">30 Days: â‚¹ <span id="month">0</span></div>

<hr>

<!-- ADD PRODUCT -->
<h3>Add Product</h3>

<input id="pname" placeholder="Product Name">
<input id="price" type="number" placeholder="Price â‚¹">
<input id="stock" type="number" placeholder="Stock">

<button onclick="addProduct()">â• Add</button>

<hr>

<!-- PRODUCTS -->
<h3>Products</h3>
<div id="products">Loading...</div>

<hr>

<!-- ORDERS -->
<h3>Orders</h3>
<div id="orders">Loading...</div>

<hr>

<button class="red" onclick="logout()">Logout</button>

</div>


<script>

/* FIREBASE */
firebase.initializeApp({
apiKey: "AIzaSyA8O4kOinBczBQ8r9mbtOdH98X70ezpgYk",
authDomain: "new-prototype-s7zo4.firebaseapp.com",
projectId: "new-prototype-s7zo4"
});

const auth=firebase.auth();
const db=firebase.firestore();

let lastOrderCount=0;


/* AUTO LOGIN */
auth.onAuthStateChanged(async user=>{

if(!user) return;

let doc=await db.collection("Users").doc(user.uid).get();

if(!doc.exists || doc.data().role!=="admin"){
alert("Not Admin âŒ");
auth.signOut();
return;
}

loginBox.style.display="none";
panel.style.display="block";

loadAll();

});


/* LOGIN */
async function login(){

try{

let cred=await auth.signInWithEmailAndPassword(
email.value,pass.value
);

let doc=await db.collection("Users")
.doc(cred.user.uid).get();

if(doc.data().role!=="admin"){
msg.innerText="Not Admin âŒ";
auth.signOut();
return;
}

loginBox.style.display="none";
panel.style.display="block";

loadAll();

}catch{
msg.innerText="Wrong Login";
}

}


/* LOGOUT */
function logout(){
auth.signOut();
location.reload();
}


/* LOAD ALL */
function loadAll(){
loadProducts();
loadOrders();
loadReport();
listenOrders();
}


/* ADD PRODUCT */
async function addProduct(){

if(!pname.value||!price.value||!stock.value)
return alert("Fill All");

await db.collection("Products").add({

name:pname.value,
price:Number(price.value),
stock:Number(stock.value),
time:firebase.firestore.FieldValue.serverTimestamp()

});

pname.value="";
price.value="";
stock.value="";

loadProducts();
alert("Added âœ…");

}


/* PRODUCTS */
async function loadProducts(){

let snap=await db.collection("Products")
.orderBy("time","desc").get();

products.innerHTML="";

if(snap.empty){
products.innerHTML="No Products";
return;
}

snap.forEach(d=>{

let p=d.data();

products.innerHTML+=`

<div class="item">

${p.name} â‚¹${p.price}
(Stock:${p.stock})

<button onclick="del('${d.id}')">âŒ</button>

</div>

`;

});

}


/* DELETE */
async function del(id){

if(!confirm("Delete?")) return;

await db.collection("Products").doc(id).delete();

loadProducts();

}


/* ORDERS */
async function loadOrders(){

let snap=await db.collection("Orders")
.orderBy("time","desc").get();

orders.innerHTML="";

if(snap.empty){
orders.innerHTML="No Orders";
return;
}

lastOrderCount=snap.size;

snap.forEach(d=>{

let o=d.data();

orders.innerHTML+=`

<div class="orderBox">

<b>${o.name}</b><br>
ğŸ“± ${o.mobile}<br>
ğŸ  ${o.address}<br><br>

${o.items}<br>

ğŸ’° â‚¹${o.total}<br>
Status: ${o.status||"Pending"}

<br><br>

<button class="orange"
onclick="cancelOrder('${d.id}')">Cancel</button>

</div>

`;

});

}


/* CANCEL */
async function cancelOrder(id){

if(!confirm("Cancel Order?")) return;

await db.collection("Orders").doc(id).update({
status:"Cancelled"
});

alert("Cancelled âŒ");
loadOrders();

}


/* REPORT */
async function loadReport(){

let snap=await db.collection("Orders").get();

let t=0,w=0,m=0;

let now=new Date();

snap.forEach(d=>{

let o=d.data();

if(!o.time||o.status=="Cancelled") return;

let dt=o.time.toDate();
let diff=(now-dt)/(1000*60*60*24);

if(diff<1) t+=o.total;
if(diff<7) w+=o.total;
if(diff<30) m+=o.total;

});

today.innerText=t;
week.innerText=w;
month.innerText=m;

}


/* NEW ORDER ALERT */
function listenOrders(){

db.collection("Orders").onSnapshot(snap=>{

if(snap.size>lastOrderCount){

alert("ğŸ“¢ New Order Received!");

loadOrders();
loadReport();

}

lastOrderCount=snap.size;

});

}

</script>

</body>
</html>

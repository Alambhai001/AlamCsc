<!DOCTYPE html>
<html>
<head>
<title>Mumbai Elite | Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">

<style>
body{
font-family:Arial;
background:#eef2f5;
margin:0;
}

header{
background:#0072bc;
color:white;
padding:15px;
text-align:center;
font-size:20px;
font-weight:bold;
}

.box{
background:white;
margin:12px;
padding:15px;
border-radius:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.profile{
display:flex;
align-items:center;
gap:10px;
}

input,button{
width:100%;
padding:10px;
margin:6px 0;
border-radius:6px;
border:1px solid #ccc;
}

button{
background:#0072bc;
color:white;
border:none;
font-weight:bold;
cursor:pointer;
}

.logout{background:red}

.post{
border:1px solid #ddd;
padding:10px;
margin:12px 0;
border-radius:10px;
}

.post img{
width:100%;
border-radius:8px;
margin:5px 0;
}

.actions{
display:flex;
justify-content:space-between;
margin-top:5px;
}

.like{color:#0072bc;cursor:pointer}
.delete{color:red;cursor:pointer}

.preview{
width:100%;
max-height:200px;
object-fit:cover;
border-radius:8px;
display:none;
}
</style>
</head>

<body>

<header>üì∏ Mumbai Elite Feed</header>

<!-- PROFILE -->
<div class="box">
<div class="profile">
<h3 id="username">Loading...</h3>
<small id="userRole"></small>
</div>
</div>

<!-- CREATE -->
<div class="box">

<h3>Create Post</h3>

<input type="file" id="postImage" accept="image/*" onchange="previewImg()">

<img id="preview" class="preview">

<input id="caption" placeholder="Write caption">

<button onclick="uploadPost()">Post</button>

</div>

<!-- FEED -->
<div class="box">

<h3>Latest Feed</h3>

<div id="feed">Loading...</div>

</div>

<!-- LOGOUT -->
<div class="box">
<button class="logout" onclick="logout()">Logout</button>
</div>


<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>


<script>

/* CONFIG */
firebase.initializeApp({
apiKey: "AIzaSyA8O4kOinBczBQ8r9mbtOdH98X70ezpgYk",
authDomain: "new-prototype-s7zo4.firebaseapp.com",
projectId: "new-prototype-s7zo4",
storageBucket: "new-prototype-s7zo4.appspot.com"
});

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

let currentUser=null;
let currentName="";


/* AUTH */
auth.onAuthStateChanged(async user=>{

if(!user){
location="index.html";
return;
}

currentUser=user;

let doc=await db.collection("Users").doc(user.uid).get();

if(doc.exists){

currentName=doc.data().name;

username.innerText="üë§ "+currentName;
userRole.innerText="("+doc.data().role+")";

}

loadPosts();

});


/* PREVIEW */
function previewImg(){

let f=postImage.files[0];

if(f){
preview.src=URL.createObjectURL(f);
preview.style.display="block";
}

}


/* UPLOAD */
async function uploadPost(){

let file=postImage.files[0];
let cap=caption.value.trim();

if(!file){
alert("Select image");
return;
}

let ref=storage.ref("posts/"+Date.now()+file.name);

await ref.put(file);

let url=await ref.getDownloadURL();

await db.collection("Posts").add({

uid:currentUser.uid,
username:currentName,
image:url,
caption:cap,
likes:0,
likedBy:[],
time:firebase.firestore.FieldValue.serverTimestamp()

});

alert("Posted ‚úÖ");

postImage.value="";
caption.value="";
preview.style.display="none";

loadPosts();

}


/* LOAD */
async function loadPosts(){

feed.innerHTML="Loading...";

let snap=await db.collection("Posts")
.orderBy("time","desc")
.get();

feed.innerHTML="";

snap.forEach(doc=>{

let p=doc.data();

let liked=(p.likedBy||[]).includes(currentUser.uid);

feed.innerHTML+=`

<div class="post">

<small>üë§ ${p.username}</small>

<img src="${p.image}">

<p>${p.caption||""}</p>

<div class="actions">

<span class="like" style="color:${liked?'red':'#0072bc'}"
onclick="likePost('${doc.id}')">

‚ù§Ô∏è ${p.likes||0}

</span>

${p.uid===currentUser.uid?

`<span class="delete" onclick="deletePost('${doc.id}','${p.image}')">
üóë Delete
</span>`:""}

</div>

</div>

`;

});

}


/* LIKE */
async function likePost(id){

let ref=db.collection("Posts").doc(id);

let snap=await ref.get();

let data=snap.data();

let arr=data.likedBy||[];

if(arr.includes(currentUser.uid)){
alert("Already liked ‚ù§Ô∏è");
return;
}

arr.push(currentUser.uid);

await ref.update({
likedBy:arr,
likes:arr.length
});

loadPosts();

}


/* DELETE */
async function deletePost(id,url){

if(!confirm("Delete post?"))return;

await db.collection("Posts").doc(id).delete();

await storage.refFromURL(url).delete();

loadPosts();

}


/* LOGOUT */
function logout(){

auth.signOut().then(()=>{
location="index.html";
});

}

</script>

</body>
</html>

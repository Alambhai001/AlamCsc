<!DOCTYPE html>
<html>
<head>
<title>Aftab Store | Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>

body{
margin:0;
font-family:Arial;
background:#eef2f3;
}

/* HEADER */
header{
background:#28a745;
color:white;
padding:15px;
text-align:center;
font-size:20px;
font-weight:bold;
}

/* BOX */
.box{
background:white;
margin:10px;
padding:15px;
border-radius:10px;
}

.product{
border:1px solid #ddd;
padding:8px;
margin:6px 0;
border-radius:6px;
}

.qty{
width:60px;
padding:5px;
margin-top:5px;
}

button{
width:100%;
padding:12px;
background:#28a745;
color:white;
border:none;
border-radius:6px;
font-weight:bold;
margin-top:10px;
}

.logout{background:red}

</style>
</head>

<body>

<header>ðŸ›’ Aftab Store</header>


<!-- USER -->
<div class="box">

<h3 id="username">Loading...</h3>

</div>


<!-- CUSTOMER INFO -->
<div class="box">

<h3>Delivery Info</h3>

<input id="name" placeholder="Your Name">
<input id="mobile" placeholder="Mobile Number">
<textarea id="address" placeholder="Address"
style="width:100%;padding:8px"></textarea>

</div>


<!-- PRODUCTS -->
<div class="box">

<h3>Products</h3>

<div id="productList">Loading...</div>

</div>


<!-- ORDER -->
<div class="box">

<button onclick="sendOrder()">ðŸ“² Order on WhatsApp</button>

<button class="logout" onclick="logout()">Logout</button>

</div>


<script>

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyA8O4kOinBczBQ8r9mbtOdH98X70ezpgYk",
authDomain:"new-prototype-s7zo4.firebaseapp.com",
projectId:"new-prototype-s7zo4"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser=null;


/* AUTH CHECK */
auth.onAuthStateChanged(async user=>{

if(!user){
location="login.html";
return;
}

currentUser=user;

loadProfile();
loadProducts();

});


/* PROFILE */
async function loadProfile(){

let doc=await db.collection("Users")
.doc(currentUser.uid).get();

if(doc.exists){

username.innerText="ðŸ‘¤ "+doc.data().name;

name.value=doc.data().name;
mobile.value=doc.data().phone;

}

}


/* LOAD PRODUCTS */
async function loadProducts(){

let list=document.getElementById("productList");

list.innerHTML="Loading...";

let snap=await db.collection("Products")
.orderBy("time","desc").get();

list.innerHTML="";

if(snap.empty){
list.innerHTML="No Products âŒ";
return;
}

snap.forEach(doc=>{

let p=doc.data();

if(p.stock<=0) return;

list.innerHTML+=`

<div class="product">

<b>${p.name}</b><br>
â‚¹${p.price}<br>
Stock: ${p.stock}<br>

Qty:
<input class="qty"
id="qty_${doc.id}"
type="number"
min="0"
value="0">

</div>

`;

});

}


/* SEND ORDER */
async function sendOrder(){

let cname=name.value.trim();
let cmobile=mobile.value.trim();
let caddr=address.value.trim();

if(!cname||!cmobile||!caddr){
alert("Fill delivery info âŒ");
return;
}

let snap=await db.collection("Products").get();

let items="";
let total=0;

snap.forEach(doc=>{

let p=doc.data();

let q=document.getElementById("qty_"+doc.id);

if(q && q.value>0){

items+=p.name+" x "+q.value+"%0A";
total+=p.price*q.value;

}

});

if(items==""){
alert("Select product âŒ");
return;
}


/* SAVE ORDER */
await db.collection("Orders").add({

name:cname,
mobile:cmobile,
address:caddr,
items:items,
total:total,
status:"Pending",
uid:currentUser.uid,
time:firebase.firestore.FieldValue.serverTimestamp()

});


/* WHATSAPP */
let msg=
"ðŸ›’ New Order%0A%0A"+
"Name: "+cname+"%0A"+
"Mobile: "+cmobile+"%0A"+
"Address: "+caddr+"%0A%0A"+
items+
"%0AðŸ’° Total: â‚¹"+total;

window.open(
"https://wa.me/919336678937?text="+msg
);

alert("Order Sent âœ…");

}


/* LOGOUT */
function logout(){

auth.signOut().then(()=>{
location="login.html";
});

}

</script>

</body>
</html>
